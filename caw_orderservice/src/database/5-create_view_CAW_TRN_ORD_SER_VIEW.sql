CREATE OR REPLACE FORCE EDITIONABLE VIEW "DTV"."CAW_TRN_ORD_SER_VIEW" (
"RETRY_COUNT", "CREATE_DATE", "UPDATE_DATE", "TRANS_SEQ", "RTL_LOC_ID", "WKSTN_ID", "BUSINESS_DATE", "BEGIN_DATETIME", "TOTAL", 
"OPERATOR_PARTY_ID", "TRANS_TYPCODE", "EMPLOYEE_ID", "EMP_FULL_NAME", "EMP_PARTY_ID", 
"STORE_NAME", "LOC_ADDRESS1", "LOC_ADDRESS2", "LOC_CITY", "LOC_STATE", "LOC_POSTAL_CODE", "LOC_COUNTRY", 
"PARTY_ID", "ALTERNATE_ID", "ORGANIZATION_TYPCODE", "SALUTATION", "FIRST_NAME", "MIDDLE_NAME", "LAST_NAME", "SUFFIX", 
"ORGANIZATION_NAME", "ADDRESS_TYPE", "ADDRESS1", "ADDRESS2", "ADDRESS3", "ADDRESS4", "CITY", "STATE", "POSTAL_CODE", "COUNTRY", "COUNTY") AS 

SELECT COS.RETRY_COUNT, COS.CREATE_DATE, COS.UPDATE_DATE, TRN.TRANS_SEQ, TRN.RTL_LOC_ID, TRN.WKSTN_ID, TRN.BUSINESS_DATE, TRN.BEGIN_DATETIME, TRN.TOTAL, 
TRN.OPERATOR_PARTY_ID,TRN.TRANS_TYPCODE, HRS.LOGIN_ID AS EMPLOYEE_ID, CONCAT(CONCAT(EMP.FIRST_NAME, ' '), EMP.LAST_NAME) AS EMP_FULL_NAME, EMP.PARTY_ID EMP_PARTY_ID, 
LOC.STORE_NAME, LOC.ADDRESS1 LOC_ADDRESS1, LOC.ADDRESS2 LOC_ADDRESS2, LOC.CITY LOC_CITY, LOC.STATE LOC_STATE, LOC.POSTAL_CODE LOC_POSTAL_CODE, LOC.COUNTRY LOC_COUNTRY,        
        COALESCE(TRL.CUST_PARTY_ID,TTCT.FUNDS_RECEIPT_PARTY_ID) AS PARTY_ID,
        COALESCE(XRE.ALTERNATE_ID,XRE2.ALTERNATE_ID) AS ALTERNATE_ID, 
        COALESCE(CRM.ORGANIZATION_TYPCODE,CRM2.ORGANIZATION_TYPCODE) AS ORGANIZATION_TYPCODE, 
        COALESCE(CRM.SALUTATION,CRM2.SALUTATION) AS SALUTATION, 
        COALESCE(CRM.FIRST_NAME,CRM2.FIRST_NAME) AS FIRST_NAME, 
        COALESCE(CRM.MIDDLE_NAME,CRM2.MIDDLE_NAME) AS MIDDLE_NAME, 
        COALESCE(CRM.LAST_NAME,CRM2.LAST_NAME) AS LAST_NAME,  
        COALESCE(CRM.SUFFIX,CRM2.SUFFIX) AS SUFFIX, 
		
        COALESCE(CRM.ORGANIZATION_NAME,CRM2.ORGANIZATION_NAME) AS ORGANIZATION_NAME,        
        COALESCE(PLI.ADDRESS_TYPE,PLI2.ADDRESS_TYPE) AS ADDRESS_TYPE,
        COALESCE(PLI.ADDRESS1,PLI2.ADDRESS1) AS ADDRESS1,
        COALESCE(PLI.ADDRESS2,PLI2.ADDRESS2) AS ADDRESS2,
        COALESCE(PLI.ADDRESS3,PLI2.ADDRESS3) AS ADDRESS3,
        COALESCE(PLI.ADDRESS4,PLI2.ADDRESS4) AS ADDRESS4,
        COALESCE(PLI.CITY,PLI2.CITY) AS CITY,
        COALESCE(PLI.STATE,PLI2.STATE) AS STATE,
        COALESCE(PLI.POSTAL_CODE,PLI2.POSTAL_CODE) AS POSTAL_CODE,
        COALESCE(PLI.COUNTRY,PLI2.COUNTRY) AS COUNTRY,
        COALESCE(PLI.COUNTY,PLI2.COUNTY) AS COUNTY
FROM CAW_TRN_ORD_SER COS 
  JOIN LOC_RTL_LOC LOC ON COS.RTL_LOC_ID = LOC.RTL_LOC_ID  
  JOIN TRN_TRANS TRN ON COS.TRANS_SEQ = TRN.TRANS_SEQ AND
    COS.RTL_LOC_ID = TRN.RTL_LOC_ID AND
    COS.WKSTN_ID = TRN.WKSTN_ID AND
    COS.BUSINESS_DATE = TRN.BUSINESS_DATE
	
  LEFT JOIN (CRM_PARTY EMP
    JOIN HRS_EMPLOYEE HRS ON HRS.PARTY_ID = EMP.PARTY_ID
    ) ON TRN.OPERATOR_PARTY_ID = EMP.PARTY_ID AND EMP.PARTY_TYPCODE = 'EMPLOYEE'
	
-- Sale Transaction and customer info
  LEFT JOIN TRL_RTRANS TRL ON COS.TRANS_SEQ = TRL.TRANS_SEQ AND
    COS.RTL_LOC_ID = TRL.RTL_LOC_ID AND
    COS.WKSTN_ID = TRL.WKSTN_ID AND
    COS.BUSINESS_DATE = TRL.BUSINESS_DATE 
  LEFT JOIN (CRM_PARTY CRM 
      LEFT JOIN CRM_PARTY_ID_XREF XRE ON CRM.PARTY_ID = XRE.PARTY_ID
      JOIN (SELECT PARTY_ID, ADDRESS_TYPE, ADDRESS1, ADDRESS2, 
                   ADDRESS3, ADDRESS4, CITY, STATE, POSTAL_CODE, COUNTRY, COUNTY, PARTY_LOCALE_SEQ 
            FROM CRM_PARTY_LOCALE_INFORMATION pli_no_min,
                (SELECT PARTY_ID PARTY_ID_min, MIN(PARTY_LOCALE_SEQ) AS PARTY_LOCALE_SEQ_min
                 FROM CRM_PARTY_LOCALE_INFORMATION
                 GROUP BY PARTY_ID) plimin
                 WHERE pli_no_min.PARTY_ID = plimin.PARTY_ID_min
                 AND pli_no_min.PARTY_LOCALE_SEQ = plimin.PARTY_LOCALE_SEQ_min
            GROUP BY PARTY_ID, ADDRESS_TYPE, ADDRESS1, ADDRESS2,
                     ADDRESS3, ADDRESS4, CITY, STATE, POSTAL_CODE, COUNTRY, COUNTY, PARTY_LOCALE_SEQ) PLI 
            ON PLI.PARTY_ID = CRM.PARTY_ID
    ) ON TRL.CUST_PARTY_ID = CRM.PARTY_ID
	
-- Tender control and customer Infor
  LEFT JOIN TSN_TNDR_CONTROL_TRANS TTCT ON COS.TRANS_SEQ = TTCT.TRANS_SEQ AND
    COS.RTL_LOC_ID = TTCT.RTL_LOC_ID AND
    COS.WKSTN_ID = TTCT.WKSTN_ID AND
    COS.BUSINESS_DATE = TTCT.BUSINESS_DATE
  LEFT JOIN (CRM_PARTY CRM2 
      LEFT JOIN CRM_PARTY_ID_XREF XRE2 ON CRM2.PARTY_ID = XRE2.PARTY_ID
      JOIN (SELECT PARTY_ID, ADDRESS_TYPE, ADDRESS1, ADDRESS2, 
                   ADDRESS3, ADDRESS4, CITY, STATE, POSTAL_CODE, COUNTRY, COUNTY, min(PARTY_LOCALE_SEQ) 
            FROM CRM_PARTY_LOCALE_INFORMATION pli_no_min,
                (SELECT PARTY_ID PARTY_ID_min, MIN(PARTY_LOCALE_SEQ) AS PARTY_LOCALE_SEQ_min
                 FROM CRM_PARTY_LOCALE_INFORMATION
                 GROUP BY PARTY_ID) plimin
                 WHERE pli_no_min.PARTY_ID = plimin.PARTY_ID_min
                 AND pli_no_min.PARTY_LOCALE_SEQ = plimin.PARTY_LOCALE_SEQ_min 
            GROUP BY PARTY_ID, ADDRESS_TYPE, ADDRESS1, ADDRESS2,
                     ADDRESS3, ADDRESS4, CITY, STATE, POSTAL_CODE, COUNTRY, COUNTY, PARTY_LOCALE_SEQ) PLI2 
            ON CRM2.PARTY_ID = PLI2.PARTY_ID
    ) ON TTCT.FUNDS_RECEIPT_PARTY_ID = CRM2.PARTY_ID
    
WHERE COS.STATUS=0 
ORDER BY COS.CREATE_DATE ASC;
